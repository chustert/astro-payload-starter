---
/**
 * Live Preview Route for Blog Posts
 * 
 * This route is used by Payload CMS Live Preview to display draft posts
 * in an iframe with real-time updates.
 */
import BaseLayout from '@templates/BaseLayout.astro';
import { getPostBySlugPreview, getMediaUrl } from '@lib/payload';

// Disable prerendering for preview routes
export const prerender = false;

// Get the slug from the URL
const { slug } = Astro.params;

// Fetch the post (including draft content)
const post = slug ? await getPostBySlugPreview(slug) : null;

// If no post found, show error
if (!post) {
  return new Response('Post not found', { status: 404 });
}

const heroImage = getMediaUrl(post.heroImage);
---

<BaseLayout 
  title={post.title}
  description={post.description}
>
  <main id="preview-content">
    <article class="blog-post">
      {heroImage && (
        <div class="hero-image">
          <img src={heroImage} alt={post.heroImage?.alt || post.title} />
        </div>
      )}
      
      <header class="post-header">
        <h1>{post.title}</h1>
        <div class="meta">
          <span class="author">By {post.author}</span>
          <span class="date">{new Date(post.pubDate).toLocaleDateString()}</span>
          {post.category && (
            <span class="category">{post.category.name}</span>
          )}
        </div>
      </header>
      
      <div class="post-content">
        <!-- Rich text content would be rendered here -->
        <!-- For now, showing raw content structure -->
        <p class="description">{post.description}</p>
        <pre class="debug">{JSON.stringify(post.content, null, 2)}</pre>
      </div>
    </article>
  </main>
</BaseLayout>

<script>
  // Live Preview integration script
  window.addEventListener('message', (event) => {
    if (event.data?.type === 'payload-live-preview') {
      window.location.reload();
    }
  });
</script>

<style>
  /* Preview mode indicator */
  main#preview-content {
    position: relative;
  }
  
  main#preview-content::before {
    content: 'PREVIEW MODE';
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    background: #f59e0b;
    color: black;
    font-size: 10px;
    font-weight: bold;
    padding: 2px 8px;
    z-index: 9999;
    border-radius: 0 0 4px 4px;
  }

  .blog-post {
    max-width: 800px;
    margin: 0 auto;
    padding: var(--space-8) var(--space-4);
  }

  .hero-image {
    margin-bottom: var(--space-6);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .hero-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  .post-header {
    margin-bottom: var(--space-6);
  }

  .post-header h1 {
    margin-bottom: var(--space-3);
  }

  .meta {
    display: flex;
    gap: var(--space-4);
    color: var(--color-text-secondary);
    font-size: var(--text-size-small);
  }

  .category {
    background: var(--color-primary-100);
    color: var(--color-primary-700);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
  }

  .debug {
    background: var(--color-neutral-100);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    overflow: auto;
    font-size: 12px;
  }
</style>
